# Clover MCP Server Architecture

## 1. Overall System Architecture

```mermaid
graph TB
    subgraph "Client Layer"
        A[Claude AI / MCP Client]
    end

    subgraph "MCP Server Layer"
        B[index.ts<br/>MCP Server]
        C[clover-client.ts<br/>API Client]
        D[oauth-v2.ts<br/>OAuth Handler]
        E[logger.ts<br/>Logger]
    end

    subgraph "Authentication"
        F[Express Server<br/>OAuth Callback]
        G[Browser<br/>User Authorization]
    end

    subgraph "External Services"
        H[Clover API<br/>sandbox.dev.clover.com]
    end

    A -->|JSON-RPC over stdio| B
    B -->|Uses| C
    B -->|Uses| E
    C -->|Uses| D
    C -->|Uses| E
    D -->|Starts| F
    F -->|Redirects to| G
    G -->|Authorizes| H
    H -->|Returns code| F
    F -->|Exchanges code| H
    H -->|Returns tokens| D
    C -->|API Requests| H

    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#fff4e1
    style D fill:#ffe1e1
    style F fill:#ffe1e1
    style H fill:#e1ffe1
```

## 2. OAuth Authentication Flow

```mermaid
sequenceDiagram
    participant User
    participant MCP as MCP Client
    participant Server as MCP Server
    participant OAuth as OAuth Handler
    participant Express as Express Server
    participant Browser
    participant Clover as Clover API

    User->>MCP: Request connection
    MCP->>Server: initiate_oauth_flow
    Server->>OAuth: startOAuthFlow(port)
    OAuth->>Express: Start server on localhost:4000
    OAuth->>Browser: Open authorization URL
    Browser->>Clover: GET /oauth/authorize
    User->>Clover: Login & Authorize
    Clover->>Browser: Redirect with code
    Browser->>Express: GET /oauth-callback?code=xxx
    Express->>Clover: POST /oauth/token<br/>(exchange code)
    Clover->>Express: Return tokens
    Express->>OAuth: Store tokens in memory
    OAuth-->>Server: Return token response
    Server-->>MCP: OAuth success message
    OAuth->>Express: Shutdown server (3s delay)

    Note over OAuth: Tokens stored in memory<br/>for subsequent API calls
```

## 3. MCP Protocol Communication

```mermaid
sequenceDiagram
    participant Client as MCP Client<br/>(Claude AI)
    participant Server as MCP Server<br/>(stdio transport)
    participant Handler as Request Handlers

    Client->>Server: initialize<br/>{protocolVersion, capabilities}
    Server-->>Client: {serverInfo, capabilities}

    Client->>Server: tools/list
    Server-->>Client: {tools: [5 tools]}

    Client->>Server: resources/templates/list
    Server-->>Client: {templates: [items, orders]}

    Client->>Server: tools/call<br/>{name: "get_oauth_status"}
    Server->>Handler: Check token validity
    Handler-->>Server: Token status
    Server-->>Client: {content: "Not authenticated"}

    Client->>Server: tools/call<br/>{name: "initiate_oauth_flow"}
    Server->>Handler: Start OAuth
    Note over Handler: OAuth flow happens<br/>(see OAuth diagram)
    Handler-->>Server: Success
    Server-->>Client: {content: "OAuth complete"}

    Client->>Server: tools/call<br/>{name: "get_merchant_info"}
    Server->>Handler: API call with token
    Handler-->>Server: Merchant data
    Server-->>Client: {content: JSON data}
```

## 4. API Request Flow with Token Management

```mermaid
sequenceDiagram
    participant Tool as Tool Call
    participant Client as CloverApiClient
    participant Interceptor as Request Interceptor
    participant OAuth as OAuthV2Client
    participant API as Clover API

    Tool->>Client: getMerchantInfo()
    Client->>Client: ensureCredentials()
    Client->>Client: Prepare request

    Client->>Interceptor: HTTP Request
    Interceptor->>OAuth: ensureValidToken()

    alt Token is valid
        OAuth-->>Interceptor: Return token
    else Token expired but refresh available
        OAuth->>API: POST /oauth/refresh
        API-->>OAuth: New tokens
        OAuth->>OAuth: Update stored tokens
        OAuth-->>Interceptor: Return new token
    else No valid tokens
        OAuth-->>Interceptor: Error
        Interceptor-->>Client: Auth error
        Client-->>Tool: "Please authenticate"
    end

    Interceptor->>Interceptor: Add Authorization header
    Interceptor->>API: GET /v3/merchants/{id}

    alt Success (200)
        API-->>Client: Merchant data
        Client-->>Tool: Return data
    else 401 Unauthorized
        API-->>Interceptor: 401 error
        Interceptor->>OAuth: refreshAccessToken()
        OAuth->>API: POST /oauth/refresh
        API-->>OAuth: New tokens
        Interceptor->>API: Retry original request
        API-->>Client: Merchant data
        Client-->>Tool: Return data
    else Other error
        API-->>Client: Error
        Client-->>Tool: Error message
    end
```

## 5. Tool Execution Flow

```mermaid
graph TD
    A[MCP Client calls tool] --> B{Which Tool?}

    B -->|list_inventory| C[List Inventory]
    B -->|list_orders| D[List Orders]
    B -->|get_merchant_info| E[Get Merchant Info]
    B -->|initiate_oauth_flow| F[Start OAuth]
    B -->|get_oauth_status| G[Check OAuth Status]

    C --> H[ensureCredentials]
    D --> H
    E --> H

    H --> I[Check access token]
    I -->|Valid| J[Make API request]
    I -->|Expired| K[Refresh token]
    I -->|Missing| L[Return auth error]

    K --> M{Refresh success?}
    M -->|Yes| J
    M -->|No| L

    J --> N[Parse response]
    N --> O[Return JSON to client]

    F --> P[Start Express server]
    P --> Q[Open browser]
    Q --> R[Wait for callback]
    R --> S[Store tokens]
    S --> T[Return success]

    G --> U[Check tokens in memory]
    U --> V[Return status]

    L --> W[Return error message]

    style F fill:#ffe1e1
    style G fill:#e1ffe1
    style C fill:#e1f5ff
    style D fill:#e1f5ff
    style E fill:#e1f5ff
    style L fill:#ffcccc
    style W fill:#ffcccc
```

## 6. Resource URI Flow

```mermaid
sequenceDiagram
    participant Client as MCP Client
    participant Server as MCP Server
    participant API as Clover API

    Client->>Server: resources/templates/list
    Server-->>Client: [clover://items/{id}, clover://orders/{id}]

    Note over Client: User requests specific item

    Client->>Server: resources/read<br/>{uri: "clover://items/ABC123"}
    Server->>Server: Parse URI pattern
    Server->>Server: Extract itemId = "ABC123"
    Server->>API: GET /v3/merchants/{mid}/items/ABC123
    API-->>Server: Item data
    Server-->>Client: {contents: [JSON data]}

    Note over Client: User requests specific order

    Client->>Server: resources/read<br/>{uri: "clover://orders/XYZ789"}
    Server->>Server: Parse URI pattern
    Server->>Server: Extract orderId = "XYZ789"
    Server->>API: GET /v3/merchants/{mid}/orders/XYZ789
    API-->>Server: Order data
    Server-->>Client: {contents: [JSON data]}
```

## 7. Token Lifecycle Management

```mermaid
stateDiagram-v2
    [*] --> NoTokens: Server starts

    NoTokens --> OAuthPending: initiate_oauth_flow called
    OAuthPending --> TokensValid: OAuth success
    OAuthPending --> NoTokens: OAuth failed

    TokensValid --> TokensExpired: Access token expires
    TokensExpired --> TokensValid: Refresh successful
    TokensExpired --> NoTokens: Refresh failed

    TokensValid --> MakingAPICall: API request
    MakingAPICall --> TokensValid: Request successful
    MakingAPICall --> TokensExpired: 401 error

    NoTokens --> [*]: Server shutdown
    TokensValid --> [*]: Server shutdown

    note right of NoTokens
        No tokens in memory
        All API calls fail
    end note

    note right of TokensValid
        Access token valid
        API calls succeed
        Auto-refresh if needed
    end note

    note right of TokensExpired
        Access token expired
        Attempts refresh
        Uses refresh token
    end note
```

## 8. Data Flow Summary

```mermaid
flowchart LR
    subgraph Input
        A[User Request via Claude]
    end

    subgraph "MCP Layer"
        B[MCP Protocol<br/>JSON-RPC]
        C[Tool Handler]
    end

    subgraph "Business Logic"
        D[API Client]
        E[Token Manager]
    end

    subgraph "External"
        F[Clover API]
    end

    subgraph Output
        G[Formatted Response]
        H[User sees result]
    end

    A --> B
    B --> C
    C --> D
    D --> E
    E -->|Bearer Token| F
    F -->|JSON Response| D
    D --> C
    C --> B
    B --> G
    G --> H

    style A fill:#e1f5ff
    style F fill:#e1ffe1
    style H fill:#e1ffe1
    style E fill:#ffe1e1
```

## Key Components

### MCP Server (index.ts)
- Handles MCP protocol communication
- Registers 5 tools and 2 resource templates
- Routes requests to appropriate handlers
- Validates and formats responses

### Clover API Client (clover-client.ts)
- Manages HTTP requests to Clover API
- Implements axios interceptors for auth
- Handles token refresh on 401 errors
- Provides typed interfaces for Clover data

### OAuth Handler (oauth-v2.ts)
- Manages OAuth 2.0 flow
- Stores tokens in memory
- Handles token refresh
- Supports both v1 and v2 endpoints (with fallback)

### Logger (logger.ts)
- Outputs to stderr (not stdout)
- Prevents pollution of MCP protocol stream
- Configurable debug mode

## Security Considerations

1. **Token Storage**: Tokens stored in memory (lost on restart)
2. **CSRF Protection**: State parameter in OAuth flow
3. **Token Refresh**: Automatic refresh before expiry
4. **Secure Transport**: HTTPS for Clover API
5. **Credential Management**: Environment variables for secrets
